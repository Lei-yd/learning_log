# 顶级配置：应用定义
applications:
  # 应用名称（唯一）
  ll_project:
    # 应用类型（必须缩进，作为ll_project的子项）
    type: 'python:3.13'
    # Web服务配置
    web:
      upstream:
        socket_family: unix
      commands:
        start: "gunicorn -w 4 -b unix:$SOCKET ll_project.wsgi:application"
      locations:
        "/":
          passthru: true
        "/static":
          root: "static"
          expires: 1h
          allow: true
    # 挂载配置（日志目录）
    mounts:
      "logs":
        source: local
        source_path: logs
    # 构建和部署钩子
    hooks:
      build: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_remote.txt
        mkdir -p logs  # 确保目录存在（删除rm -rf logs，避免误删）
        python manage.py collectstatic --noinput  # 非交互式执行
      deploy: |
        python manage.py migrate
    # 关联服务（关联下面定义的postgresql服务）
    relationships:
      database: "db:postgresql"   # "db"是下面services中定义的服务名

# 顶级配置：路由规则（与applications同级，而非应用内部）
routes:
  "https://{default}/":
    type: upstream
    upstream: "ll_project:http"  # 关联上面定义的应用ll_project
  "https://www.{default}/":
    type: redirect
    to: "https://{default}/"

# 顶级配置：服务定义（与applications同级，而非应用内部）
services:
  # 服务名称（唯一，这里用db）
  db:
    type: postgresql:18  # 数据库类型和版本
